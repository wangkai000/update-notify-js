767bbbc6f73e305c31ab857bcc4e6abd
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const index_1 = require("../src/index");
// 模拟全局浏览器环境
const mockBrowserEnvironment = () => {
    // 创建一个模拟对象来跟踪浏览器API调用
    const browserCalls = {
        fetch: [],
        confirm: [],
        reload: [],
        setTimeout: [],
        clearTimeout: [],
        addEventListener: []
    };
    // 模拟fetch函数
    jest.doMock('undici', () => ({
        fetch: jest.fn((...args) => {
            browserCalls.fetch.push(args);
            return Promise.resolve({
                text: () => Promise.resolve('<html><script src="/test.js"></script></html>')
            });
        })
    }));
    // 全局变量模拟
    global.window = {
        ...global.window,
        confirm: jest.fn((...args) => {
            browserCalls.confirm.push(args);
            return true;
        })
    };
    global.document = {
        ...global.document,
        addEventListener: jest.fn((...args) => {
            browserCalls.addEventListener.push(args);
        }),
        removeEventListener: jest.fn(),
        hidden: false
    };
    global.setTimeout = jest.fn((callback) => {
        browserCalls.setTimeout.push([callback]);
        // 立即执行回调以便测试
        if (typeof callback === 'function') {
            callback();
        }
        return 1;
    });
    global.clearTimeout = jest.fn((...args) => {
        browserCalls.clearTimeout.push(args);
    });
    // 返回跟踪对象
    return browserCalls;
};
describe('VersionUpdateNotifier 基本功能测试', () => {
    let browserCalls;
    beforeEach(() => {
        jest.clearAllMocks();
        browserCalls = mockBrowserEnvironment();
    });
    test('创建实例时不会抛出错误', () => {
        expect(() => new index_1.VersionUpdateNotifier()).not.toThrow();
    });
    test('createUpdateNotifier工厂函数返回正确类型', () => {
        const notifier = (0, index_1.createUpdateNotifier)();
        expect(notifier).toBeInstanceOf(index_1.VersionUpdateNotifier);
    });
    test('公共方法存在且可调用', () => {
        const notifier = new index_1.VersionUpdateNotifier({ pollingInterval: 0 });
        expect(typeof notifier.start).toBe('function');
        expect(typeof notifier.stop).toBe('function');
        expect(typeof notifier.reset).toBe('function');
        expect(typeof notifier.checkNow).toBe('function');
        expect(typeof notifier.checkUpdate).toBe('function');
    });
    test('start方法可以正常调用', () => {
        const notifier = new index_1.VersionUpdateNotifier({ pollingInterval: 10000 });
        expect(() => notifier.start()).not.toThrow();
    });
    test('stop方法可以正常调用', () => {
        const notifier = new index_1.VersionUpdateNotifier({ pollingInterval: 10000 });
        notifier.start();
        expect(() => notifier.stop()).not.toThrow();
    });
    test('reset方法可以正常调用', () => {
        const notifier = new index_1.VersionUpdateNotifier({ pollingInterval: 10000 });
        notifier.start();
        expect(() => notifier.reset()).not.toThrow();
    });
    test('配置验证正常工作', () => {
        // 测试无效的notificationType
        expect(() => {
            // @ts-ignore
            new index_1.VersionUpdateNotifier({ notificationType: 'invalid' });
        }).toThrow();
    });
});
describe('VersionUpdateNotifier 回调测试', () => {
    beforeEach(() => {
        jest.clearAllMocks();
    });
    test('onUpdate回调在更新时被调用', async () => {
        const onUpdateMock = jest.fn();
        const notifier = new index_1.VersionUpdateNotifier({
            pollingInterval: 0,
            notificationType: 'custom',
            onUpdate: onUpdateMock
        });
        // 模拟fetch响应
        const originalFetch = global.fetch;
        global.fetch = jest.fn().mockResolvedValue({
            text: () => Promise.resolve('<html><script src="/test.js"></script></html>')
        });
        // 调用检查方法
        await notifier.checkNow();
        // 恢复fetch
        global.fetch = originalFetch;
        // 验证回调没有被调用（初始检测）
        expect(onUpdateMock).not.toHaveBeenCalled();
    });
    test('onDetected回调可以正常工作', async () => {
        const onDetectedMock = jest.fn();
        const notifier = new index_1.VersionUpdateNotifier({
            pollingInterval: 0,
            onDetected: onDetectedMock
        });
        // 调用检查方法
        await notifier.checkNow();
        // 验证回调没有被调用（初始检测）
        expect(onDetectedMock).not.toHaveBeenCalled();
    });
});
describe('VersionUpdateNotifier 集成测试', () => {
    beforeEach(() => {
        jest.clearAllMocks();
    });
    test('完整的检测流程不会抛出错误', async () => {
        const notifier = new index_1.VersionUpdateNotifier({ pollingInterval: 0 });
        // 模拟fetch
        global.fetch = jest.fn().mockResolvedValue({
            text: () => Promise.resolve('<html><script src="/test.js"></script></html>')
        });
        // 验证checkNow不会抛出错误
        await expect(notifier.checkNow()).resolves.not.toThrow();
    });
    test('使用confirm类型的通知配置', async () => {
        const notifier = new index_1.VersionUpdateNotifier({
            pollingInterval: 0,
            notificationType: 'confirm'
        });
        // 模拟confirm
        const originalConfirm = window.confirm;
        window.confirm = jest.fn().mockReturnValue(false);
        // 调用checkUpdate
        await notifier.checkUpdate();
        // 恢复confirm
        window.confirm = originalConfirm;
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL1NoYXJlZC9QcmV2aW91c2x5IFJlbG9jYXRlZCBJdGVtcy9TZWN1cml0eS9teVByb2ppZWN0L2FpX3Byb2pldC90ZXN0cy9pbmRleC50ZXN0LnRzIiwibWFwcGluZ3MiOiI7O0FBQUEsd0NBQWtHO0FBRWxHLFlBQVk7QUFDWixNQUFNLHNCQUFzQixHQUFHLEdBQUcsRUFBRTtJQUNsQyxzQkFBc0I7SUFDdEIsTUFBTSxZQUFZLEdBQUc7UUFDbkIsS0FBSyxFQUFFLEVBQUU7UUFDVCxPQUFPLEVBQUUsRUFBRTtRQUNYLE1BQU0sRUFBRSxFQUFFO1FBQ1YsVUFBVSxFQUFFLEVBQUU7UUFDZCxZQUFZLEVBQUUsRUFBRTtRQUNoQixnQkFBZ0IsRUFBRSxFQUFFO0tBQ3JCLENBQUM7SUFFRixZQUFZO0lBQ1osSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztRQUMzQixLQUFLLEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEdBQUcsSUFBSSxFQUFFLEVBQUU7WUFDekIsWUFBWSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDOUIsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDO2dCQUNyQixJQUFJLEVBQUUsR0FBRyxFQUFFLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQywrQ0FBK0MsQ0FBQzthQUM3RSxDQUFDLENBQUM7UUFDTCxDQUFDLENBQUM7S0FDSCxDQUFDLENBQUMsQ0FBQztJQUVKLFNBQVM7SUFDVCxNQUFNLENBQUMsTUFBTSxHQUFHO1FBQ2QsR0FBRyxNQUFNLENBQUMsTUFBTTtRQUNoQixPQUFPLEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEdBQUcsSUFBSSxFQUFFLEVBQUU7WUFDM0IsWUFBWSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDaEMsT0FBTyxJQUFJLENBQUM7UUFDZCxDQUFDLENBQUM7S0FDSSxDQUFDO0lBRVQsTUFBTSxDQUFDLFFBQVEs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cyI6WyIvVXNlcnMvU2hhcmVkL1ByZXZpb3VzbHkgUmVsb2NhdGVkIEl0ZW1zL1NlY3VyaXR5L215UHJvamllY3QvYWlfcHJvamV0L3Rlc3RzL2luZGV4LnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVmVyc2lvblVwZGF0ZU5vdGlmaWVyLCBVcGRhdGVOb3RpZmllck9wdGlvbnMsIGNyZWF0ZVVwZGF0ZU5vdGlmaWVyIH0gZnJvbSAnLi4vc3JjL2luZGV4JztcblxuLy8g5qih5ouf5YWo5bGA5rWP6KeI5Zmo546v5aKDXG5jb25zdCBtb2NrQnJvd3NlckVudmlyb25tZW50ID0gKCkgPT4ge1xuICAvLyDliJvlu7rkuIDkuKrmqKHmi5/lr7nosaHmnaXot5/ouKrmtY/op4jlmahBUEnosIPnlKhcbiAgY29uc3QgYnJvd3NlckNhbGxzID0ge1xuICAgIGZldGNoOiBbXSxcbiAgICBjb25maXJtOiBbXSxcbiAgICByZWxvYWQ6IFtdLFxuICAgIHNldFRpbWVvdXQ6IFtdLFxuICAgIGNsZWFyVGltZW91dDogW10sXG4gICAgYWRkRXZlbnRMaXN0ZW5lcjogW11cbiAgfTtcblxuICAvLyDmqKHmi59mZXRjaOWHveaVsFxuICBqZXN0LmRvTW9jaygndW5kaWNpJywgKCkgPT4gKHtcbiAgICBmZXRjaDogamVzdC5mbigoLi4uYXJncykgPT4ge1xuICAgICAgYnJvd3NlckNhbGxzLmZldGNoLnB1c2goYXJncyk7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHtcbiAgICAgICAgdGV4dDogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCc8aHRtbD48c2NyaXB0IHNyYz1cIi90ZXN0LmpzXCI+PC9zY3JpcHQ+PC9odG1sPicpXG4gICAgICB9KTtcbiAgICB9KVxuICB9KSk7XG5cbiAgLy8g5YWo5bGA5Y+Y6YeP5qih5oufXG4gIGdsb2JhbC53aW5kb3cgPSB7XG4gICAgLi4uZ2xvYmFsLndpbmRvdyxcbiAgICBjb25maXJtOiBqZXN0LmZuKCguLi5hcmdzKSA9PiB7XG4gICAgICBicm93c2VyQ2FsbHMuY29uZmlybS5wdXNoKGFyZ3MpO1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfSlcbiAgfSBhcyBhbnk7XG5cbiAgZ2xvYmFsLmRvY3VtZW50ID0ge1xuICAgIC4uLmdsb2JhbC5kb2N1bWVudCxcbiAgICBhZGRFdmVudExpc3RlbmVyOiBqZXN0LmZuKCguLi5hcmdzKSA9PiB7XG4gICAgICBicm93c2VyQ2FsbHMuYWRkRXZlbnRMaXN0ZW5lci5wdXNoKGFyZ3MpO1xuICAgIH0pLFxuICAgIHJlbW92ZUV2ZW50TGlzdGVuZXI6IGplc3QuZm4oKSxcbiAgICBoaWRkZW46IGZhbHNlXG4gIH0gYXMgYW55O1xuXG4gIGdsb2JhbC5zZXRUaW1lb3V0ID0gamVzdC5mbigoY2FsbGJhY2spID0+IHtcbiAgICBicm93c2VyQ2FsbHMuc2V0VGltZW91dC5wdXNoKFtjYWxsYmFja10pO1xuICAgIC8vIOeri+WNs+aJp+ihjOWbnuiwg+S7peS+v+a1i+ivlVxuICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgIGNhbGxiYWNrKCk7XG4gICAgfVxuICAgIHJldHVybiAxO1xuICB9KTtcblxuICBnbG9iYWwuY2xlYXJUaW1lb3V0ID0gamVzdC5mbigoLi4uYXJncykgPT4ge1xuICAgIGJyb3dzZXJDYWxscy5jbGVhclRpbWVvdXQucHVzaChhcmdzKTtcbiAgfSk7XG5cbiAgLy8g6L+U5Zue6Lef6Liq5a+56LGhXG4gIHJldHVybiBicm93c2VyQ2FsbHM7XG59O1xuXG5kZXNjcmliZSgnVmVyc2lvblVwZGF0ZU5vdGlmaWVyIOWfuuacrOWKn+iDvea1i+ivlScsICgpID0+IHtcbiAgbGV0IGJyb3dzZXJDYWxsczogUmV0dXJuVHlwZTx0eXBlb2YgbW9ja0Jyb3dzZXJFbnZpcm9ubWVudD47XG5cbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgamVzdC5jbGVhckFsbE1vY2tzKCk7XG4gICAgYnJvd3NlckNhbGxzID0gbW9ja0Jyb3dzZXJFbnZpcm9ubWVudCgpO1xuICB9KTtcblxuICB0ZXN0KCfliJvlu7rlrp7kvovml7bkuI3kvJrmipvlh7rplJnor68nLCAoKSA9PiB7XG4gICAgZXhwZWN0KCgpID0+IG5ldyBWZXJzaW9uVXBkYXRlTm90aWZpZXIoKSkubm90LnRvVGhyb3coKTtcbiAgfSk7XG5cbiAgdGVzdCgnY3JlYXRlVXBkYXRlTm90aWZpZXLlt6XljoLlh73mlbDov5Tlm57mraPnoa7nsbvlnosnLCAoKSA9PiB7XG4gICAgY29uc3Qgbm90aWZpZXIgPSBjcmVhdGVVcGRhdGVOb3RpZmllcigpO1xuICAgIGV4cGVjdChub3RpZmllcikudG9CZUluc3RhbmNlT2YoVmVyc2lvblVwZGF0ZU5vdGlmaWVyKTtcbiAgfSk7XG5cbiAgdGVzdCgn5YWs5YWx5pa55rOV5a2Y5Zyo5LiU5Y+v6LCD55SoJywgKCkgPT4ge1xuICAgIGNvbnN0IG5vdGlmaWVyID0gbmV3IFZlcnNpb25VcGRhdGVOb3RpZmllcih7IHBvbGxpbmdJbnRlcnZhbDogMCB9KTtcbiAgICBcbiAgICBleHBlY3QodHlwZW9mIG5vdGlmaWVyLnN0YXJ0KS50b0JlKCdmdW5jdGlvbicpO1xuICAgIGV4cGVjdCh0eXBlb2Ygbm90aWZpZXIuc3RvcCkudG9CZSgnZnVuY3Rpb24nKTtcbiAgICBleHBlY3QodHlwZW9mIG5vdGlmaWVyLnJlc2V0KS50b0JlKCdmdW5jdGlvbicpO1xuICAgIGV4cGVjdCh0eXBlb2Ygbm90aWZpZXIuY2hlY2tOb3cpLnRvQmUoJ2Z1bmN0aW9uJyk7XG4gICAgZXhwZWN0KHR5cGVvZiBub3RpZmllci5jaGVja1VwZGF0ZSkudG9CZSgnZnVuY3Rpb24nKTtcbiAgfSk7XG5cbiAgdGVzdCgnc3RhcnTmlrnms5Xlj6/ku6XmraPluLjosIPnlKgnLCAoKSA9PiB7XG4gICAgY29uc3Qgbm90aWZpZXIgPSBuZXcgVmVyc2lvblVwZGF0ZU5vdGlmaWVyKHsgcG9sbGluZ0ludGVydmFsOiAxMDAwMCB9KTtcbiAgICBleHBlY3QoKCkgPT4gbm90aWZpZXIuc3RhcnQoKSkubm90LnRvVGhyb3coKTtcbiAgfSk7XG5cbiAgdGVzdCgnc3RvcOaWueazleWPr+S7peato+W4uOiwg+eUqCcsICgpID0+IHtcbiAgICBjb25zdCBub3RpZmllciA9IG5ldyBWZXJzaW9uVXBkYXRlTm90aWZpZXIoeyBwb2xsaW5nSW50ZXJ2YWw6IDEwMDAwIH0pO1xuICAgIG5vdGlmaWVyLnN0YXJ0KCk7XG4gICAgZXhwZWN0KCgpID0+IG5vdGlmaWVyLnN0b3AoKSkubm90LnRvVGhyb3coKTtcbiAgfSk7XG5cbiAgdGVzdCgncmVzZXTmlrnms5Xlj6/ku6XmraPluLjosIPnlKgnLCAoKSA9PiB7XG4gICAgY29uc3Qgbm90aWZpZXIgPSBuZXcgVmVyc2lvblVwZGF0ZU5vdGlmaWVyKHsgcG9sbGluZ0ludGVydmFsOiAxMDAwMCB9KTtcbiAgICBub3RpZmllci5zdGFydCgpO1xuICAgIGV4cGVjdCgoKSA9PiBub3RpZmllci5yZXNldCgpKS5ub3QudG9UaHJvdygpO1xuICB9KTtcblxuICB0ZXN0KCfphY3nva7pqozor4HmraPluLjlt6XkvZwnLCAoKSA9PiB7XG4gICAgLy8g5rWL6K+V5peg5pWI55qEbm90aWZpY2F0aW9uVHlwZVxuICAgIGV4cGVjdCgoKSA9PiB7XG4gICAgICAvLyBAdHMtaWdub3JlXG4gICAgICBuZXcgVmVyc2lvblVwZGF0ZU5vdGlmaWVyKHsgbm90aWZpY2F0aW9uVHlwZTogJ2ludmFsaWQnIH0pO1xuICAgIH0pLnRvVGhyb3coKTtcbiAgfSk7XG59KTtcblxuZGVzY3JpYmUoJ1ZlcnNpb25VcGRhdGVOb3RpZmllciDlm57osIPmtYvor5UnLCAoKSA9PiB7XG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIGplc3QuY2xlYXJBbGxNb2NrcygpO1xuICB9KTtcblxuICB0ZXN0KCdvblVwZGF0ZeWbnuiwg+WcqOabtOaWsOaXtuiiq+iwg+eUqCcsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBvblVwZGF0ZU1vY2sgPSBqZXN0LmZuKCk7XG4gICAgY29uc3Qgbm90aWZpZXIgPSBuZXcgVmVyc2lvblVwZGF0ZU5vdGlmaWVyKHtcbiAgICAgIHBvbGxpbmdJbnRlcnZhbDogMCxcbiAgICAgIG5vdGlmaWNhdGlvblR5cGU6ICdjdXN0b20nLFxuICAgICAgb25VcGRhdGU6IG9uVXBkYXRlTW9ja1xuICAgIH0pO1xuXG4gICAgLy8g5qih5oufZmV0Y2jlk43lupRcbiAgICBjb25zdCBvcmlnaW5hbEZldGNoID0gZ2xvYmFsLmZldGNoO1xuICAgIChnbG9iYWwgYXMgYW55KS5mZXRjaCA9IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7XG4gICAgICB0ZXh0OiAoKSA9PiBQcm9taXNlLnJlc29sdmUoJzxodG1sPjxzY3JpcHQgc3JjPVwiL3Rlc3QuanNcIj48L3NjcmlwdD48L2h0bWw+JylcbiAgICB9KTtcblxuICAgIC8vIOiwg+eUqOajgOafpeaWueazlVxuICAgIGF3YWl0IG5vdGlmaWVyLmNoZWNrTm93KCk7XG4gICAgXG4gICAgLy8g5oGi5aSNZmV0Y2hcbiAgICAoZ2xvYmFsIGFzIGFueSkuZmV0Y2ggPSBvcmlnaW5hbEZldGNoO1xuXG4gICAgLy8g6aqM6K+B5Zue6LCD5rKh5pyJ6KKr6LCD55So77yI5Yid5aeL5qOA5rWL77yJXG4gICAgZXhwZWN0KG9uVXBkYXRlTW9jaykubm90LnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgfSk7XG5cbiAgdGVzdCgnb25EZXRlY3RlZOWbnuiwg+WPr+S7peato+W4uOW3peS9nCcsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBvbkRldGVjdGVkTW9jayA9IGplc3QuZm4oKTtcbiAgICBjb25zdCBub3RpZmllciA9IG5ldyBWZXJzaW9uVXBkYXRlTm90aWZpZXIoe1xuICAgICAgcG9sbGluZ0ludGVydmFsOiAwLFxuICAgICAgb25EZXRlY3RlZDogb25EZXRlY3RlZE1vY2tcbiAgICB9KTtcblxuICAgIC8vIOiwg+eUqOajgOafpeaWueazlVxuICAgIGF3YWl0IG5vdGlmaWVyLmNoZWNrTm93KCk7XG5cbiAgICAvLyDpqozor4Hlm57osIPmsqHmnInooqvosIPnlKjvvIjliJ3lp4vmo4DmtYvvvIlcbiAgICBleHBlY3Qob25EZXRlY3RlZE1vY2spLm5vdC50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gIH0pO1xufSk7XG5cbmRlc2NyaWJlKCdWZXJzaW9uVXBkYXRlTm90aWZpZXIg6ZuG5oiQ5rWL6K+VJywgKCkgPT4ge1xuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICBqZXN0LmNsZWFyQWxsTW9ja3MoKTtcbiAgfSk7XG5cbiAgdGVzdCgn5a6M5pW055qE5qOA5rWL5rWB56iL5LiN5Lya5oqb5Ye66ZSZ6K+vJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IG5vdGlmaWVyID0gbmV3IFZlcnNpb25VcGRhdGVOb3RpZmllcih7IHBvbGxpbmdJbnRlcnZhbDogMCB9KTtcbiAgICBcbiAgICAvLyDmqKHmi59mZXRjaFxuICAgIChnbG9iYWwgYXMgYW55KS5mZXRjaCA9IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7XG4gICAgICB0ZXh0OiAoKSA9PiBQcm9taXNlLnJlc29sdmUoJzxodG1sPjxzY3JpcHQgc3JjPVwiL3Rlc3QuanNcIj48L3NjcmlwdD48L2h0bWw+JylcbiAgICB9KTtcblxuICAgIC8vIOmqjOivgWNoZWNrTm935LiN5Lya5oqb5Ye66ZSZ6K+vXG4gICAgYXdhaXQgZXhwZWN0KG5vdGlmaWVyLmNoZWNrTm93KCkpLnJlc29sdmVzLm5vdC50b1Rocm93KCk7XG4gIH0pO1xuXG4gIHRlc3QoJ+S9v+eUqGNvbmZpcm3nsbvlnovnmoTpgJrnn6XphY3nva4nLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3Qgbm90aWZpZXIgPSBuZXcgVmVyc2lvblVwZGF0ZU5vdGlmaWVyKHtcbiAgICAgIHBvbGxpbmdJbnRlcnZhbDogMCxcbiAgICAgIG5vdGlmaWNhdGlvblR5cGU6ICdjb25maXJtJ1xuICAgIH0pO1xuXG4gICAgLy8g5qih5oufY29uZmlybVxuICAgIGNvbnN0IG9yaWdpbmFsQ29uZmlybSA9IHdpbmRvdy5jb25maXJtO1xuICAgICh3aW5kb3cgYXMgYW55KS5jb25maXJtID0gamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZShmYWxzZSk7XG5cbiAgICAvLyDosIPnlKhjaGVja1VwZGF0ZVxuICAgIGF3YWl0IG5vdGlmaWVyLmNoZWNrVXBkYXRlKCk7XG5cbiAgICAvLyDmgaLlpI1jb25maXJtXG4gICAgKHdpbmRvdyBhcyBhbnkpLmNvbmZpcm0gPSBvcmlnaW5hbENvbmZpcm07XG4gIH0pO1xufSk7Il0sInZlcnNpb24iOjN9