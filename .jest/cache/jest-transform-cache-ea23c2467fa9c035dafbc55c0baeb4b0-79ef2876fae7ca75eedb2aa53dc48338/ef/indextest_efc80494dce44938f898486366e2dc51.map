{"file":"/Users/Shared/Previously Relocated Items/Security/myProjiect/ai_projet/tests/index.test.ts","mappings":"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","names":[],"sources":["/Users/Shared/Previously Relocated Items/Security/myProjiect/ai_projet/tests/index.test.ts"],"sourcesContent":["import { createUpdateNotifier, VersionUpdateNotifier } from '../src/index';\n\n// 模拟全局环境\njest.mock('../src/index', () => {\n  const original = jest.requireActual('../src/index');\n  return {\n    ...original,\n    // 我们将在测试中模拟需要的方法\n  };\n});\n\n// 类型定义\ndeclare global {\n  interface Window {\n    __VERSION_UPDATE_TEST__?: boolean;\n  }\n}\n\ndescribe('VersionUpdateNotifier', () => {\n  // 模拟全局对象\n  let originalFetch: any;\n  let originalSetTimeout: any;\n  let originalClearTimeout: any;\n  let originalConfirm: any;\n  let originalLocationReload: any;\n  let originalAddEventListener: any;\n  let originalRemoveEventListener: any;\n  \n  beforeEach(() => {\n    // 保存原始方法\n    originalFetch = globalThis.fetch;\n    originalSetTimeout = globalThis.setTimeout;\n    originalClearTimeout = globalThis.clearTimeout;\n    originalConfirm = globalThis.confirm;\n    originalAddEventListener = document.addEventListener;\n    originalRemoveEventListener = document.removeEventListener;\n    \n    // 使用jest.spyOn来安全地模拟方法，避免重定义只读属性\n    jest.spyOn(document.defaultView!.location, 'reload').mockImplementation(() => {});\n    \n    // 创建一个模拟对象来处理页面可见性\n    (document as any).__visibilityState = 'visible';\n    jest.spyOn(document, 'hidden', 'get').mockImplementation(() => (document as any).__visibilityState === 'hidden');\n    \n    // 模拟定时器\n    globalThis.setTimeout = jest.fn((callback) => {\n      const timerId = 1;\n      // 不实际执行定时器，通过测试手动控制\n      return timerId;\n    });\n    \n    globalThis.clearTimeout = jest.fn();\n    \n    // 模拟confirm\n    globalThis.confirm = jest.fn();\n    \n    // 模拟事件监听器\n    document.addEventListener = jest.fn();\n    document.removeEventListener = jest.fn();\n  });\n  \n  afterEach(() => {\n    // 恢复原始方法\n    globalThis.fetch = originalFetch;\n    globalThis.setTimeout = originalSetTimeout;\n    globalThis.clearTimeout = originalClearTimeout;\n    globalThis.confirm = originalConfirm;\n    document.addEventListener = originalAddEventListener;\n    document.removeEventListener = originalRemoveEventListener;\n    \n    // 恢复所有的mock\n    jest.restoreAllMocks();\n    delete (document as any).__visibilityState;\n  });\n  \n  describe('构造函数', () => {\n    test('使用默认配置初始化', () => {\n      const notifier = new VersionUpdateNotifier();\n      \n      expect(notifier).toBeInstanceOf(VersionUpdateNotifier);\n      // 测试自动轮询是否启动\n      expect(globalThis.setTimeout).toHaveBeenCalled();\n    });\n    \n    test('使用手动模式初始化', () => {\n      const notifier = new VersionUpdateNotifier({ pollingInterval: 0 });\n      \n      expect(notifier).toBeInstanceOf(VersionUpdateNotifier);\n      // 手动模式下不应该启动自动轮询\n      expect(globalThis.setTimeout).not.toHaveBeenCalled();\n    });\n    \n    test('配置页面可见性监听', () => {\n      new VersionUpdateNotifier({ pauseOnHidden: true });\n      \n      expect(document.addEventListener).toHaveBeenCalledWith('visibilitychange', expect.any(Function));\n    });\n  });\n  \n  describe('公共方法', () => {\n    let notifier: VersionUpdateNotifier;\n    \n    beforeEach(() => {\n      notifier = new VersionUpdateNotifier({ pollingInterval: 0 }); // 手动模式\n    });\n    \n    test('start方法启动检测', () => {\n      // 重置setTimeout调用计数\n      jest.clearAllMocks();\n      \n      notifier.start();\n      \n      expect(globalThis.setTimeout).toHaveBeenCalled();\n    });\n    \n    test('stop方法停止检测', () => {\n      // 先启动检测\n      notifier.start();\n      jest.clearAllMocks();\n      \n      notifier.stop();\n      \n      expect(globalThis.clearTimeout).toHaveBeenCalled();\n    });\n    \n    test('reset方法重置状态', () => {\n      jest.clearAllMocks();\n      \n      notifier.reset();\n      \n      expect(globalThis.clearTimeout).toHaveBeenCalled();\n    });\n  });\n  \n  describe('createUpdateNotifier工厂函数', () => {\n    test('返回VersionUpdateNotifier实例', () => {\n      const notifier = createUpdateNotifier();\n      \n      expect(notifier).toBeInstanceOf(VersionUpdateNotifier);\n    });\n    \n    test('正确传递配置参数', () => {\n      // 由于我们无法直接访问私有属性，这里测试行为\n      const customInterval = 5000;\n      const notifier = createUpdateNotifier({ pollingInterval: customInterval });\n      \n      expect(notifier).toBeInstanceOf(VersionUpdateNotifier);\n    });\n  });\n  \n  describe('更新检测逻辑', () => {\n    test('checkNow方法（静默检测）', async () => {\n      // 模拟fetch返回的HTML内容\n      const mockHtml = `\n        <html>\n          <head>\n            <script src=\"/static/js/main.123456.js\"></script>\n          </head>\n        </html>\n      `;\n      \n      globalThis.fetch = jest.fn().mockResolvedValue({\n        text: jest.fn().mockResolvedValue(mockHtml)\n      });\n      \n      const notifier = new VersionUpdateNotifier({ pollingInterval: 0 });\n      \n      // 第一次调用应该返回false（首次记录）\n      const result1 = await (notifier as any).needUpdate();\n      expect(result1).toBe(false);\n      \n      // 模拟第二次调用，返回相同的内容\n      const result2 = await (notifier as any).needUpdate();\n      expect(result2).toBe(false);\n    });\n    \n    test('检测到script变化', async () => {\n      // 第一次fetch的内容\n      const mockHtml1 = `\n        <html>\n          <head>\n            <script src=\"/static/js/main.123456.js\"></script>\n          </head>\n        </html>\n      `;\n      \n      // 第二次fetch的内容（有变化）\n      const mockHtml2 = `\n        <html>\n          <head>\n            <script src=\"/static/js/main.654321.js\"></script>\n          </head>\n        </html>\n      `;\n      \n      // 模拟fetch依次返回不同内容\n      globalThis.fetch = jest.fn()\n        .mockResolvedValueOnce({\n          text: jest.fn().mockResolvedValue(mockHtml1)\n        })\n        .mockResolvedValueOnce({\n          text: jest.fn().mockResolvedValue(mockHtml2)\n        });\n      \n      const notifier = new VersionUpdateNotifier({ pollingInterval: 0 });\n      \n      // 第一次调用\n      await (notifier as any).needUpdate();\n      \n      // 第二次调用应该检测到变化\n      const result = await (notifier as any).needUpdate();\n      expect(result).toBe(true);\n    });\n  });\n  \n  describe('用户交互', () => {\n    test('用户交互测试', async () => {\n      const notifier = new VersionUpdateNotifier({ pollingInterval: 0 });\n      \n      // 通过公共API进行测试，避免访问私有方法\n      await notifier.checkNow();\n      \n      // 验证基本功能正常\n      expect(notifier).toBeInstanceOf(VersionUpdateNotifier);\n    });\n    \n    test('自定义onUpdate回调', async () => {\n      const mockOnUpdate = jest.fn().mockResolvedValue(true);\n      \n      const notifier = new VersionUpdateNotifier({\n        pollingInterval: 0,\n        notifyType: 'custom',\n        onUpdate: mockOnUpdate\n      });\n      \n      // 使用公共API测试\n      await notifier.checkNow();\n      \n      expect(mockOnUpdate).not.toHaveBeenCalled(); // 初始化时不应调用\n    });\n    \n    test('自定义onUpdate回调', async () => {\n      const mockOnUpdate = jest.fn().mockResolvedValue(true);\n      \n      const notifier = new VersionUpdateNotifier({\n        pollingInterval: 0,\n        notifyType: 'custom',\n        onUpdate: mockOnUpdate\n      });\n      \n      // 模拟有更新\n      (notifier as any).needUpdate = jest.fn().mockResolvedValue(true);\n      \n      await notifier.checkUpdate();\n      \n      expect(mockOnUpdate).toHaveBeenCalled();\n      expect(window.location.reload).toHaveBeenCalled();\n    });\n  });\n  \n  describe('页面可见性处理', () => {\n    test('页面隐藏时暂停检测', () => {\n      const notifier = new VersionUpdateNotifier({\n        pauseOnHidden: true,\n        pollingInterval: 10000\n      });\n      \n      // 模拟添加事件监听器的回调\n      const eventListeners: any = {};\n      document.addEventListener = jest.fn((event, callback) => {\n        eventListeners[event] = callback;\n      });\n      \n      // 模拟页面隐藏\n      (document as any).__visibilityState = 'hidden';\n      if (eventListeners.visibilitychange) {\n        eventListeners.visibilitychange();\n      }\n      \n      // 验证定时器被清除\n      expect(globalThis.clearTimeout).toHaveBeenCalled();\n    });\n    \n    test('页面显示时恢复检测', () => {\n      const notifier = new VersionUpdateNotifier({\n        pauseOnHidden: true,\n        pollingInterval: 10000\n      });\n      \n      // 模拟添加事件监听器的回调\n      const eventListeners: any = {};\n      document.addEventListener = jest.fn((event, callback) => {\n        eventListeners[event] = callback;\n      });\n      \n      // 先模拟隐藏\n      (document as any).__visibilityState = 'hidden';\n      if (eventListeners.visibilitychange) {\n        eventListeners.visibilitychange();\n      }\n      \n      jest.clearAllMocks();\n      \n      // 然后模拟显示\n      (document as any).__visibilityState = 'visible';\n      if (eventListeners.visibilitychange) {\n        eventListeners.visibilitychange();\n      }\n      \n      // 验证重新设置定时器\n      expect(globalThis.setTimeout).toHaveBeenCalled();\n    });\n  });\n});"],"version":3}